name: Reusable Deploy Service

on:
  workflow_call:
    inputs:
      SERVICE_NAME:
        required: true
        type: string
      DEPLOY_ENV:
        required: true
        type: string
      GIT_BRANCH:
        required: true
        type: string
      COMPOSE_FILE:
        required: true
        type: string
    secrets:
      PROJECT_DIR:
        required: true
      SSH_HOST:
        required: true
      SSH_USER:
        required: true
      SSH_KEY:
        required: true
      DEPLOY_PORT:
        required: true
      
      SERVICE_SERVER_PORT:
        required: true
      DB_NAME:
        required: true
      DB_URL:
        required: true
      DB_USER:
        required: true
      DB_PASSWORD:
        required: true
        
      SPRING_KAFKA_BOOTSTRAP_SERVERS:
        required: true

      JWT_SECRET:
        required: true
      JWT_REFRESH_SECRET:
        required: true
      CORS_ALLOWED_ORIGINS:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy ${{ inputs.SERVICE_NAME }} to ${{ inputs.DEPLOY_ENV }}
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            set -e
            
            echo "üì¶ Deploying service: ${{ inputs.SERVICE_NAME }}"
            PROJECT_DIR="${{ secrets.PROJECT_DIR }}"
            SERVICE_DIR="$PROJECT_DIR/backend/${{ inputs.SERVICE_NAME }}"
            SERVICE_PATH="backend/${{ inputs.SERVICE_NAME }}"
            DEPLOY_ENV="${{ inputs.DEPLOY_ENV }}"
            COMPOSE_FILE="${{ inputs.COMPOSE_FILE }}"
            GIT_BRANCH="${{ inputs.GIT_BRANCH }}"

            TEMP_DIR=$(mktemp -d)
            echo "üõ† Created temp directory: $TEMP_DIR"

            echo "üîÅ Fetching service code..."
            git clone --branch "$GIT_BRANCH" --depth 1 \
              --filter=blob:none --sparse \
              https://github.com/${{ github.repository }} "$TEMP_DIR"

            cd "$TEMP_DIR"
            git sparse-checkout init --no-cone
            git sparse-checkout set \
              "$SERVICE_PATH" \
              "backend/shared-dto" \
              "backend/pom.xml" \
              "backend/shared-dto/pom.xml"

            echo "üìÇ Copying service files..."
            mkdir -p "$SERVICE_DIR"
            rsync -av --delete "$TEMP_DIR/$SERVICE_PATH/" "$SERVICE_DIR/"
            rsync -av "$TEMP_DIR/backend/pom.xml" "$PROJECT_DIR/backend/"
            rsync -av "$TEMP_DIR/backend/shared-dto/pom.xml" "$PROJECT_DIR/backend/shared-dto/"

            cd "$PROJECT_DIR"
            rm -rf "$TEMP_DIR"
            
            echo "üìÅ Creating .env for ${{ inputs.SERVICE_NAME }}"
            ENV_PATH="$SERVICE_DIR/.env"
            
            cat <<EOF > "$ENV_PATH"
            SERVICE_SERVER_PORT=${{ secrets.SERVICE_SERVER_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_URL=${{ secrets.DB_URL }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
            CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
            SPRING_KAFKA_BOOTSTRAP_SERVERS=${{ secrets.SPRING_KAFKA_BOOTSTRAP_SERVERS }}
            EOF
            
            echo "üîÑ Restarting Docker container..."
            cd "$SERVICE_DIR"
            cd ..
            docker compose --env-file "$ENV_PATH" -f "${{ inputs.SERVICE_NAME }}/$COMPOSE_FILE" down -v || true
            docker compose --env-file "$ENV_PATH" -f "${{ inputs.SERVICE_NAME }}/$COMPOSE_FILE" up -d --build
            
            echo "‚úÖ Successfully deployed ${{ inputs.SERVICE_NAME }}!"