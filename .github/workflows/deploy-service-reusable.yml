name: Reusable Deploy Service

on:
  workflow_call:
    inputs:
      SERVICE_NAME:
        required: true
        type: string
      DEPLOY_ENV:
        required: true
        type: string
      GIT_BRANCH:
        required: true
        type: string
      COMPOSE_FILE:
        required: true
        type: string
    secrets:
      PROJECT_DIR:
        required: true
      SSH_HOST:
        required: true
      SSH_USER:
        required: true
      SSH_KEY:
        required: true
      DEPLOY_PORT:
        required: true
      
      SERVICE_SERVER_PORT:
        required: true
      DB_NAME:
        required: true
      DB_URL:
        required: true
      DB_USER:
        required: true
      DB_PASSWORD:
        required: true
      SPRING_KAFKA_BOOTSTRAP_SERVERS:
        required: true
      JWT_SECRET:
        required: true
      JWT_REFRESH_SECRET:
        required: true
      CORS_ALLOWED_ORIGINS:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy ${{ inputs.SERVICE_NAME }} to ${{ inputs.DEPLOY_ENV }}
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
            
            echo "üì¶ Deploying service: ${{ inputs.SERVICE_NAME }}"
            PROJECT_DIR="${{ secrets.PROJECT_DIR }}"
            SERVICE_DIR="$PROJECT_DIR/backend/${{ inputs.SERVICE_NAME }}"
            SERVICE_PATH="backend/${{ inputs.SERVICE_NAME }}"
            DEPLOY_ENV="${{ inputs.DEPLOY_ENV }}"
            COMPOSE_FILE="${{ inputs.COMPOSE_FILE }}"
            GIT_BRANCH="${{ inputs.GIT_BRANCH }}"
            
            # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            TEMP_DIR=$(mktemp -d)
            echo "üõ† Created temp directory: $TEMP_DIR"
            
            # 2. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ (—á–∞—Å—Ç–∏—á–Ω—ã–π –∫–ª–æ–Ω)
            echo "üîÅ Fetching service code..."
            git clone --branch "$GIT_BRANCH" --depth 1 \
              --filter=blob:none --sparse \
              https://github.com/${{ github.repository }} "$TEMP_DIR"
            
            cd "$TEMP_DIR"
            git sparse-checkout set "$SERVICE_PATH"
            
            # 3. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
            echo "üìÇ Copying service files..."
            mkdir -p "$SERVICE_DIR"
            rsync -av --delete "$TEMP_DIR/$SERVICE_PATH/" "$SERVICE_DIR/"
            
            # 4. –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            cd "$PROJECT_DIR"
            rm -rf "$TEMP_DIR"
            
            # 5. –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
            echo "üìÅ Creating .env for ${{ inputs.SERVICE_NAME }}"
            ENV_PATH="$SERVICE_DIR/.env"
            
            cat <<EOF > "$ENV_PATH"
            SERVICE_SERVER_PORT=${{ secrets.SERVICE_SERVER_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_URL=${{ secrets.DB_URL }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
            CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
            SPRING_KAFKA_BOOTSTRAP_SERVERS=${{ secrets.SPRING_KAFKA_BOOTSTRAP_SERVERS }}
            EOF
            
            # 6. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
            echo "üîÑ Restarting Docker container..."
            cd "$SERVICE_DIR"
            docker compose --env-file "$ENV_PATH" -f "$COMPOSE_FILE" down || true
            docker compose --env-file "$ENV_PATH" -f "$COMPOSE_FILE" up -d --build
            
            echo "‚úÖ Successfully deployed ${{ inputs.SERVICE_NAME }}!"