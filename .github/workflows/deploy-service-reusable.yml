name: Reusable Deploy Service

on:
  workflow_call:
    inputs:
      SERVICE_NAME:
        required: true
        type: string
      DEPLOY_ENV:
        required: true
        type: string
      GIT_BRANCH:
        required: true
        type: string
      COMPOSE_FILE:
        required: true
        type: string
    secrets:
      PROJECT_DIR:
        required: true
      SSH_HOST:
        required: true
      SSH_USER:
        required: true
      SSH_KEY:
        required: true
      DEPLOY_PORT:
        required: true
      SERVICE_SERVER_PORT:
        required: true
      DB_NAME:
        required: true
      DB_URL:
        required: true
      DB_USER:
        required: true
      DB_PASSWORD:
        required: true
      SPRING_KAFKA_BOOTSTRAP_SERVERS:
        required: true
      JWT_SECRET:
        required: true
      JWT_REFRESH_SECRET:
        required: true
      CORS_ALLOWED_ORIGINS:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy ${{ inputs.SERVICE_NAME }} to ${{ inputs.DEPLOY_ENV }}
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            set -e
            
            echo "üì¶ Deploying service: ${{ inputs.SERVICE_NAME }}"
            PROJECT_DIR="${{ secrets.PROJECT_DIR }}"
            SERVICE_NAME="${{ inputs.SERVICE_NAME }}"
            SERVICE_DIR="$PROJECT_DIR/backend/$SERVICE_NAME"
            DEPLOY_ENV="${{ inputs.DEPLOY_ENV }}"
            COMPOSE_FILE="${{ inputs.COMPOSE_FILE }}"
            GIT_BRANCH="${{ inputs.GIT_BRANCH }}"

            TEMP_DIR=$(mktemp -d)
            echo "üõ† Created temp directory: $TEMP_DIR"

            echo "üîÅ Cloning repository with precise file control..."
            git clone --branch "$GIT_BRANCH" --depth 1 \
              --filter=blob:none --no-checkout \
              https://github.com/${{ github.repository }} "$TEMP_DIR"
            
            cd "$TEMP_DIR"
            
            echo "‚öôÔ∏è Setting up precise file checkout..."
            git sparse-checkout init --no-cone
            git sparse-checkout set \
              "backend/$SERVICE_NAME" \
              "backend/shared-dto/src" \
              "backend/shared-dto/pom.xml" \
              "backend/pom.xml"
            
            git checkout "$GIT_BRANCH"
            
            echo "üì§ Syncing files to remote project dir..."
            mkdir -p "$PROJECT_DIR/backend"
            rsync -av --delete "$TEMP_DIR/backend/$SERVICE_NAME/" "$PROJECT_DIR/backend/$SERVICE_NAME/"
            mkdir -p "$PROJECT_DIR/backend/shared-dto"
            rsync -av --delete "$TEMP_DIR/backend/shared-dto/src/" "$PROJECT_DIR/backend/shared-dto/src/"
            cp -v "$TEMP_DIR/backend/shared-dto/pom.xml" "$PROJECT_DIR/backend/shared-dto/pom.xml"
            cp -v "$TEMP_DIR/backend/pom.xml" "$PROJECT_DIR/backend/pom.xml"

            echo "üîç Verifying file structure..."
            test -f "$PROJECT_DIR/backend/pom.xml"
            test -f "$PROJECT_DIR/backend/shared-dto/pom.xml"

            echo "üß† Check if shared-dto changed..."
            SHARED_DTO_DIR="$PROJECT_DIR/backend/shared-dto"
            SHARED_DTO_HASH_FILE="$SHARED_DTO_DIR/.build-hash"
                    
            NEW_HASH=$(find "$SHARED_DTO_DIR/src" "$SHARED_DTO_DIR/pom.xml" -type f -exec sha256sum {} + | sort | sha256sum | cut -d" " -f1)
            echo "üîç Shared DTO hash: $NEW_HASH"
                    
            if [ ! -f "$SHARED_DTO_HASH_FILE" ] || [ "$NEW_HASH" != "$(cat $SHARED_DTO_HASH_FILE)" ]; then
              echo "üì¶ Ensuring Maven local repository exists..."
              mkdir -p "$PROJECT_DIR/.m2"
              ln -sfn "$PROJECT_DIR/.m2" ~/.m2
                    
              echo "üî® Building shared-dto..."
              cd "$SHARED_DTO_DIR"
              mvn clean install -DskipTests -f "$SHARED_DTO_DIR/pom.xml" -Dparent.relativePath=../pom.xml 2>&1 | tee build.log
              BUILD_RESULT=${PIPESTATUS[0]}
              if [ "$BUILD_RESULT" -ne 0 ]; then
                echo "‚ùå Maven build failed. See log:"
                cat build.log
                exit $BUILD_RESULT
              fi
                    
              echo "$NEW_HASH" > "$SHARED_DTO_HASH_FILE"
            else
              echo "‚úÖ shared-dto is unchanged. Skipping build."
            fi

            echo "üìÅ Creating .env..."
            ENV_PATH="$SERVICE_DIR/.env"
            cat <<EOF > "$ENV_PATH"
            SERVICE_SERVER_PORT=${{ secrets.SERVICE_SERVER_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_URL=${{ secrets.DB_URL }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
            CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
            SPRING_KAFKA_BOOTSTRAP_SERVERS=${{ secrets.SPRING_KAFKA_BOOTSTRAP_SERVERS }}
            EOF
            
            echo "üîÑ Rebuilding Docker container..."
            cd "$PROJECT_DIR/backend"
            docker compose --env-file "$ENV_PATH" -f "$SERVICE_NAME/$COMPOSE_FILE" down --remove-orphans --volumes
            docker compose --env-file "$ENV_PATH" -f "$SERVICE_NAME/$COMPOSE_FILE" up -d --build

            echo "‚úÖ Successfully deployed $SERVICE_NAME!"